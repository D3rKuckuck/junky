{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Управление с ПК</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Видео с камеры</h5>
                        <img id="cameraFeed" src="{{ url_for('video_feed') }}" class="img-fluid" alt="Camera Feed">
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Управление</h5>
                        
                        <div class="text-center mb-3">
                            <div class="control-grid">
                                <button class="btn btn-outline-primary control-btn" data-key="w">W</button>
                                <button class="btn btn-outline-primary control-btn" data-key="a">A</button>
                                <button class="btn btn-outline-primary control-btn" data-key="s">S</button>
                                <button class="btn btn-outline-primary control-btn" data-key="d">D</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Скорость: <span id="speedValue">0</span></label>
                            <div class="progress mb-2">
                                <div id="speedBar" class="progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="speed-controls">
                                <button class="btn btn-sm btn-outline-secondary speed-btn" data-speed="0">0%</button>
                                <button class="btn btn-sm btn-outline-secondary speed-btn" data-speed="32">12.5%</button>
                                <button class="btn btn-sm btn-outline-secondary speed-btn" data-speed="64">25%</button>
                                <button class="btn btn-sm btn-outline-secondary speed-btn" data-speed="96">37.5%</button>
                                <button class="btn btn-sm btn-outline-secondary speed-btn" data-speed="128">50%</button>
                                <button class="btn btn-sm btn-outline-secondary speed-btn" data-speed="160">62.5%</button>
                                <button class="btn btn-sm btn-outline-secondary speed-btn" data-speed="192">75%</button>
                                <button class="btn btn-sm btn-outline-secondary speed-btn" data-speed="224">87.5%</button>
                                <button class="btn btn-sm btn-outline-secondary speed-btn" data-speed="255">100%</button>
                            </div>
                        </div>
                        
                        <div class="current-state mb-3">
                            <h6>Текущее состояние:</h6>
                            <div class="small">
                                <div>Направление: <span id="directionState">-</span></div>
                                <div>Скорость: <span id="currentSpeedState">0</span></div>
                            </div>
                        </div>
                        
                        <button id="releaseControl" class="btn btn-warning w-100">Освободить управление</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.control-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
    max-width: 150px;
    margin: 0 auto;
}

.control-grid button:nth-child(1) { grid-column: 2; }
.control-grid button:nth-child(2) { grid-column: 1; grid-row: 2; }
.control-grid button:nth-child(3) { grid-column: 2; grid-row: 2; }
.control-grid button:nth-child(4) { grid-column: 3; grid-row: 2; }

.control-btn.active {
    background-color: #007bff;
    color: white;
}

.speed-controls {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 3px;
}

.speed-btn.active {
    background-color: #28a745;
    color: white;
    border-color: #28a745;
}

.current-state {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

#speedHint {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 14px;
    z-index: 1000;
    transition: opacity 0.3s;
    opacity: 0;
}

.speed-btn.active {
    background-color: #28a745;
    color: white;
    border-color: #28a745;
    transform: scale(1.05);
    transition: all 0.2s ease;
}

.progress-bar {
    transition: width 0.3s ease;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const speedLevels = [0, 32, 64, 96, 128, 160, 192, 224, 255];
    let currentSpeedIndex = 0; // Текущий индекс в массиве скоростей
    let currentSpeed = 0;
    let activeKeys = new Set();
    
    // Обработка кнопок управления направлением
    document.querySelectorAll('.control-btn').forEach(btn => {
        btn.addEventListener('mousedown', () => {
            const key = btn.dataset.key;
            activeKeys.add(key);
            handleKey(key, 1);
            updateDirectionState();
        });
        
        btn.addEventListener('mouseup', () => {
            const key = btn.dataset.key;
            activeKeys.delete(key);
            handleKey(key, 0);
            updateDirectionState();
        });
        
        btn.addEventListener('mouseleave', () => {
            const key = btn.dataset.key;
            if (activeKeys.has(key)) {
                activeKeys.delete(key);
                handleKey(key, 0);
                updateDirectionState();
            }
        });
    });
    
    // Обработка кнопок скорости
    document.querySelectorAll('.speed-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const speed = parseInt(btn.dataset.speed);
            setSpeedByValue(speed);
        });
    });
    
    // Освобождение управления
    document.getElementById('releaseControl').addEventListener('click', releaseControl);
    
    // Обработка клавиатуры
    document.addEventListener('keydown', (e) => {
        const keyMap = {
            'KeyW': 'w', 'KeyA': 'a', 'KeyS': 's', 'KeyD': 'd',
            'ArrowUp': 'arrow_up', 'ArrowDown': 'arrow_down'
        };
        
        if (keyMap[e.code] && !activeKeys.has(keyMap[e.code])) {
            e.preventDefault();
            
            if (e.code === 'ArrowUp' || e.code === 'ArrowDown') {
                // Обработка стрелок для изменения скорости
                handleSpeedChange(e.code);
            } else {
                // Обработка WASD для направления
                activeKeys.add(keyMap[e.code]);
                handleKey(keyMap[e.code], 1);
                updateDirectionState();
            }
        }
    });
    
    document.addEventListener('keyup', (e) => {
        const keyMap = {
            'KeyW': 'w', 'KeyA': 'a', 'KeyS': 's', 'KeyD': 'd',
            'ArrowUp': 'arrow_up', 'ArrowDown': 'arrow_down'
        };
        
        if (keyMap[e.code] && (e.code === 'KeyW' || e.code === 'KeyA' || e.code === 'KeyS' || e.code === 'KeyD')) {
            e.preventDefault();
            activeKeys.delete(keyMap[e.code]);
            handleKey(keyMap[e.code], 0);
            updateDirectionState();
        }
    });
    
    function handleSpeedChange(key) {
        if (key === 'ArrowUp') {
            // Увеличиваем скорость
            if (currentSpeedIndex < speedLevels.length - 1) {
                currentSpeedIndex++;
                setSpeedByIndex(currentSpeedIndex);
            }
        } else if (key === 'ArrowDown') {
            // Уменьшаем скорость
            if (currentSpeedIndex > 0) {
                currentSpeedIndex--;
                setSpeedByIndex(currentSpeedIndex);
            }
        }
    }
    
    function setSpeedByIndex(index) {
        const speed = speedLevels[index];
        setSpeedByValue(speed);
        currentSpeedIndex = index;
    }
    
    function setSpeedByValue(speed) {
        currentSpeed = speed;
        currentSpeedIndex = speedLevels.indexOf(speed);
        updateSpeedDisplay();
        
        // Снимаем выделение со всех кнопок скорости
        document.querySelectorAll('.speed-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Выделяем активную кнопку скорости
        const activeSpeedBtn = document.querySelector(`[data-speed="${speed}"]`);
        if (activeSpeedBtn) {
            activeSpeedBtn.classList.add('active');
        }
        
        // Отправляем скорость на сервер
        sendSpeed(speed);
    }
    
    function handleKey(key, state) {
        fetch('/api/keypress', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({key: key, state: state})
        });
        
        // Визуальная обратная связь
        const btn = document.querySelector(`[data-key="${key}"]`);
        if (btn) {
            btn.classList.toggle('active', state === 1);
        }
    }
    
    function sendSpeed(speed) {
        fetch('/api/speed', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({speed_level: speed})
        });
    }
    
    function updateSpeedDisplay() {
        const speedValue = document.getElementById('speedValue');
        const speedBar = document.getElementById('speedBar');
        const currentSpeedState = document.getElementById('currentSpeedState');
        
        // Процент для прогресс-бара (0-255 -> 0-100%)
        const percentage = (currentSpeed / 255) * 100;
        
        speedValue.textContent = currentSpeed;
        currentSpeedState.textContent = currentSpeed;
        speedBar.style.width = `${percentage}%`;
        
        // Показываем подсказку о текущем уровне скорости
        showSpeedHint();
    }
    
    function showSpeedHint() {
        // Временно показываем подсказку о изменении скорости
        const hint = document.getElementById('speedHint') || createSpeedHint();
        const speedPercent = Math.round((currentSpeed / 255) * 100);
        hint.textContent = `Скорость: ${speedPercent}%`;
        hint.style.opacity = '1';
        
        // Скрываем подсказку через 1.5 секунды
        clearTimeout(hint.timeout);
        hint.timeout = setTimeout(() => {
            hint.style.opacity = '0';
        }, 1500);
    }
    
    function createSpeedHint() {
        const hint = document.createElement('div');
        hint.id = 'speedHint';
        hint.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            transition: opacity 0.3s;
            opacity: 0;
        `;
        document.body.appendChild(hint);
        return hint;
    }
    
    function updateDirectionState() {
        const directionState = document.getElementById('directionState');
        let direction = '-';
        
        if (activeKeys.size > 0) {
            const directions = [];
            if (activeKeys.has('w')) directions.push('Вперед');
            if (activeKeys.has('s')) directions.push('Назад');
            if (activeKeys.has('a')) directions.push('Влево');
            if (activeKeys.has('d')) directions.push('Вправо');
            direction = directions.join(' + ');
        }
        
        directionState.textContent = direction;
    }
    
    function releaseControl() {
        // Отпускаем все активные клавиши
        activeKeys.forEach(key => {
            handleKey(key, 0);
        });
        activeKeys.clear();
        updateDirectionState();
        
        fetch('/api/release_control', {method: 'POST'})
            .then(() => window.location.href = '/');
    }
    
    // Инициализация - устанавливаем скорость 0
    setSpeedByValue(0);
});
</script>
{% endblock %}